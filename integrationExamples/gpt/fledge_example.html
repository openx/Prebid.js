<html>
<head>
  <!--
    FLEDGE configuration with GPT for direct and PBS requests

    gulp serve --modules=fledgeForGpt,openxOrtbBidAdapter,prebidServerBidAdapter
  -->
  <script async src="../../build/dev/prebid.js"></script>
  <script async src="https://www.googletagservices.com/tag/js/gpt.js"></script>
  <script>
    var FAILSAFE_TIMEOUT = 3000;
    var PREBID_TIMEOUT = 1500;

    var pbjs = pbjs || {};
    pbjs.que = pbjs.que || [];

    var googletag = googletag || {};
    googletag.cmd = googletag.cmd || [];

    googletag.cmd.push(function() {
      googletag.pubads().disableInitialLoad();
    });

    var adUnits = [{
      code: 'div-gpt-ad-1460505748561-0',
      mediaTypes: {
        banner: {
          sizes: [[300, 250]]
        }
      },
      bids: [{
        bidder: 'openx',
        params: {
          platform: '8869ec2c-9d3f-4f16-9d2f-49aaab8978fb',
          unit: '111111'
        }
      },
      {
        bidder: 'openx-via-pbs-go',
        params: {
          platform: '8869ec2c-9d3f-4f16-9d2f-49aaab8978fb',
          unit: '111111'
        }
      },
      {
        bidder: 'openx-via-pbs-java',
        params: {
          platform: '8869ec2c-9d3f-4f16-9d2f-49aaab8978fb',
          unit: '111111'
        }
      }],
      ortb2Imp: {
        ext: {
          ae: 1
        }
      }
    }];

    pbjs.que.push(function() {
      pbjs.setConfig({
        fledgeForGpt: {
          enabled: true
        },
        s2sConfig: [{ // PBS-Go
          accountId : '1',
          enabled : true,
          secure: 0,
          endpoint: {
            p1Consent: 'http://localhost:8000/openrtb2/auction',
            noP1Consent: 'http://localhost:8000/openrtb2/auction'
          },
          bidders: ['openx-via-pbs-go'],
          adapter: 'prebidServer',
          extPrebid: {
            aliases: {
              'openx-via-pbs-go': 'openx'
            }
          },
          timeout: 1500,
          userSyncLimit: 0,
        },
        { // PBS-Java
          accountId : '2',
          enabled : true,
          secure: 0,
          endpoint: {
            p1Consent: 'http://localhost:8080/openrtb2/auction',
            noP1Consent: 'http://localhost:8080/openrtb2/auction'
          },
          bidders: ['openx-via-pbs-java'],
          adapter: 'prebidServer',
          extPrebid: {
            aliases: {
              'openx-via-pbs-java': 'openx'
            }
          },
          timeout: 1500,
          userSyncLimit: 0
        }]
      });

      pbjs.setBidderConfig({
        bidders: ['openx-prebidjs', 'openx-via-pbs-go', 'openx-via-pbs-java'],
        config: {
          fledgeEnabled: true
        }
      });

      pbjs.addAdUnits(adUnits);

      pbjs.requestBids({
        bidsBackHandler: sendAdserverRequest,
        timeout: PREBID_TIMEOUT
      });

      function sendAdserverRequest() {
        if (pbjs.adserverRequestSent) return;
        pbjs.adserverRequestSent = true;
        googletag.cmd.push(function() {
          pbjs.que.push(function() {
            pbjs.setTargetingForGPTAsync();
            googletag.pubads().refresh();
          });
        });
      }

      setTimeout(function() {
        sendAdserverRequest();
      }, FAILSAFE_TIMEOUT);
    });

    googletag.cmd.push(function() {
      googletag
        .defineSlot('/19968336/header-bid-tag-0', adUnits[0].mediaTypes.banner.sizes, 'div-gpt-ad-1460505748561-0')
        .addService(googletag.pubads());

      googletag.pubads().enableSingleRequest();
      googletag.enableServices();
    });
  </script>
</head>

<body>
    <h2>Prebid.js FLEDGE+GPT Example</h2>

    <h5>Div-1</h5>
    <div id='div-gpt-ad-1460505748561-0'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1460505748561-0'); });
    </script>
    </div>
</body>
</html>
